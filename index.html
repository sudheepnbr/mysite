<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OIH PDF - Stable OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --gold: #c9a035; }
        body { margin: 0; font-family: sans-serif; background: #111; color: white; }
        .navbar { background: #000; padding: 15px; border-bottom: 2px solid var(--gold); display: flex; justify-content: center; gap: 15px; position: sticky; top:0; z-index:100; }
        .btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-ocr { background: #4f46e5; color: white; }
        .btn-save { background: #10b981; color: white; }
        
        #workspace { padding: 40px; display: flex; justify-content: center; }
        #canvas-wrap { position: relative; background: white; border: 1px solid #444; }
        canvas { display: block; }

        /* FIXED BOX STYLING */
        .editable-field { 
            position: absolute; 
            color: black; 
            background: rgba(255,255,255,0.8); 
            border: 1px solid rgba(79, 70, 229, 0.2);
            outline: none;
            padding: 2px;
            line-height: 1.2;
            overflow: visible;
        }
        .editable-field:focus { background: white; border: 1px solid var(--gold); z-index: 1000; }
    </style>
</head>
<body>

<div class="navbar">
    <input type="file" id="pdf-input" accept="application/pdf" style="display:none">
    <button class="btn" style="background:var(--gold)" onclick="document.getElementById('pdf-input').click()">üìÇ LOAD</button>
    <button class="btn btn-ocr" onclick="stableOCR()">üîç FIX & EDIT TEXT</button>
    <button class="btn btn-save" onclick="saveFixedPDF()">üíæ DOWNLOAD</button>
</div>

<div id="workspace">
    <div id="canvas-wrap">
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>

<script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    let pdfData = null;
    let fields = [];

    document.getElementById('pdf-input').onchange = async (e) => {
        const file = e.target.files[0];
        pdfData = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
        const page = await pdf.getPage(1);
        const vp = page.getViewport({scale: 2.0}); // Higher scale for better OCR
        const canvas = document.getElementById('pdf-canvas');
        canvas.height = vp.height; canvas.width = vp.width;
        await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
        document.getElementById('canvas-wrap').style.width = canvas.width + 'px';
    };

    async function stableOCR() {
        if(!pdfData) return;
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        
        // We use 'blocks' instead of 'words' to prevent the page from looking messy
        const { data } = await worker.recognize(document.getElementById('pdf-canvas'));
        
        data.blocks.forEach(block => {
            if(block.text.trim().length < 2) return; // Skip noise/dots

            const el = document.createElement('div');
            el.className = 'editable-field';
            el.contentEditable = true;
            el.innerText = block.text;
            el.dataset.old = block.text;

            el.style.left = block.bbox.x0 + 'px';
            el.style.top = block.bbox.y0 + 'px';
            el.style.width = (block.bbox.x1 - block.bbox.x0) + 'px';
            // height is auto to handle multi-line edits
            el.style.fontSize = "14px"; 

            document.getElementById('canvas-wrap').appendChild(el);
            fields.push(el);
        });
        await worker.terminate();
        alert("OCR Fixed. Text is grouped by blocks now.");
    }

    async function saveFixedPDF() {
        const doc = await PDFDocument.load(pdfData, { ignoreEncryption: true });
        const font = await doc.embedFont(StandardFonts.Helvetica);
        const page = doc.getPages()[0];
        const { width, height } = page.getSize();
        const canvas = document.getElementById('pdf-canvas');
        const sx = width / canvas.width, sy = height / canvas.height;

        fields.forEach(el => {
            if(el.innerText !== el.dataset.old) {
                const r = el.getBoundingClientRect();
                const cr = canvas.getBoundingClientRect();
                const x = (r.left - cr.left) * sx;
                const y = height - ((r.top - cr.top) * sy) - (r.height * sy);

                page.drawRectangle({ x, y, width: r.width*sx, height: r.height*sy, color: rgb(1,1,1) });
                page.drawText(el.innerText, { x, y: y + 2, size: 10, font, color: rgb(0,0,0) });
            }
        });

        const bytes = await doc.save();
        const blob = new Blob([bytes], {type: 'application/pdf'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Fixed_Document.pdf";
        a.click();
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OIH PDF Ultimate - Fix V94</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        :root { --gold: #c9a035; --dark: #101010; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; overflow: hidden; }
        
        /* Toolbar UI */
        .menu { background: #000; padding: 12px; border-bottom: 2px solid var(--gold); display: flex; justify-content: center; gap: 10px; z-index: 1000; position: relative; }
        .btn { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-tool { background: var(--gold); color: #000; }
        .btn-action { background: #333; color: #fff; }
        .btn-save { background: #10b981; color: white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }

        /* Workspace */
        #viewport { height: calc(100vh - 75px); overflow: auto; padding: 40px; background: #252525; text-align: center; }
        #pdf-container { position: relative; display: inline-block; background: white; box-shadow: 0 0 50px rgba(0,0,0,0.8); transition: 0.3s; }
        canvas { display: block; }

        /* Editing Overlays */
        .mask, .text-box { position: absolute; cursor: move; transition: outline 0.1s; }
        .mask { background: white; outline: 1px dashed #007bff; min-width: 10px; min-height: 10px; }
        .text-box { color: black; min-width: 40px; outline: 1px dashed var(--gold); padding: 4px; background: rgba(255,255,255,0.8); font-size: 14px; line-height: 1; white-space: nowrap; font-family: Arial, sans-serif; }
        
        .resizer { width: 12px; height: 12px; background: var(--gold); position: absolute; right: 0; bottom: 0; cursor: se-resize; border-radius: 2px; }
        .del-btn { position: absolute; top: -12px; right: -12px; background: #ff4444; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; font-weight: bold; }

        /* Export Clean Mode (Hides all UI elements) */
        .export-mode .mask, .export-mode .text-box { outline: none !important; border: none !important; }
        .export-mode .resizer, .export-mode .del-btn { display: none !important; }
    </style>
</head>
<body>

<div class="menu">
    <input type="file" id="pdf-file" accept="application/pdf" style="display:none">
    <button class="btn btn-action" onclick="document.getElementById('pdf-file').click()">üìÇ Open PDF</button>
    <button class="btn btn-tool" onclick="addMask()">‚¨ú Erase (Whiteout)</button>
    <button class="btn btn-tool" onclick="addText()">‚ûï Add New Text</button>
    <button class="btn btn-action" id="undoBtn" onclick="undo()" disabled>‚Ü©Ô∏è Undo</button>
    <button class="btn btn-save" onclick="savePdf()">üíæ DOWNLOAD FINAL PDF</button>
</div>

<div id="viewport">
    <div id="pdf-container">
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>

<script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    let originalBytes = null;
    let overlays = [];
    let history = [];

    // --- 1. THE LOADER ---
    document.getElementById('pdf-file').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        originalBytes = await file.arrayBuffer();
        
        const loadingTask = pdfjsLib.getDocument({data: originalBytes});
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1); // Page 1
        const viewport = page.getViewport({scale: 1.5});
        
        const canvas = document.getElementById('pdf-canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({canvasContext: context, viewport: viewport}).promise;
        const cont = document.getElementById('pdf-container');
        cont.style.width = canvas.width + 'px';
        cont.style.height = canvas.height + 'px';
    };

    function addMask() { saveState(); createUI('mask'); }
    function addText() { saveState(); createUI('text-box'); }

    function createUI(type, saved = null) {
        const div = document.createElement('div');
        div.className = type;
        div.dataset.type = type;
        div.style.left = saved ? saved.x : "100px";
        div.style.top = saved ? saved.y : "100px";
        
        const del = document.createElement('div');
        del.className = 'del-btn';
        del.innerHTML = '‚úï';
        del.onclick = (e) => { e.stopPropagation(); saveState(); div.remove(); overlays = overlays.filter(o => o !== div); };
        div.appendChild(del);

        if(type === 'text-box') {
            div.contentEditable = true;
            div.innerText = saved ? saved.t : "Click to type";
            div.onblur = () => saveState();
        } else {
            div.style.width = saved ? saved.w : "120px";
            div.style.height = saved ? saved.h : "30px";
            const rs = document.createElement('div');
            rs.className = 'resizer';
            div.appendChild(rs);
            setupResize(div, rs);
        }

        document.getElementById('pdf-container').appendChild(div);
        setupDrag(div);
        overlays.push(div);
    }

    // --- 2. CONTROLS ---
    function setupDrag(el) {
        el.onmousedown = (e) => {
            if(e.target.className === 'resizer' || e.target.className === 'del-btn') return;
            let sx = e.clientX - el.offsetLeft, sy = e.clientY - el.offsetTop;
            document.onmousemove = (e) => {
                el.style.left = (e.clientX - sx) + 'px';
                el.style.top = (e.clientY - sy) + 'px';
            };
            document.onmouseup = () => { document.onmousemove = null; saveState(); };
        };
    }

    function setupResize(el, rs) {
        rs.onmousedown = (e) => {
            e.stopPropagation();
            document.onmousemove = (e) => {
                el.style.width = Math.max(10, e.clientX - el.getBoundingClientRect().left) + 'px';
                el.style.height = Math.max(10, e.clientY - el.getBoundingClientRect().top) + 'px';
            };
            document.onmouseup = () => { document.onmousemove = null; saveState(); };
        };
    }

    function saveState() {
        const data = overlays.map(o => ({ type: o.dataset.type, x: o.style.left, y: o.style.top, w: o.style.width, h: o.style.height, t: o.innerText }));
        history.push(JSON.stringify(data));
        document.getElementById('undoBtn').disabled = false;
    }

    function undo() {
        if(history.length === 0) return;
        overlays.forEach(o => o.remove());
        overlays = [];
        const last = JSON.parse(history.pop());
        last.forEach(s => createUI(s.type, s));
        if(history.length === 0) document.getElementById('undoBtn').disabled = true;
    }

    // --- 3. THE "FLATTEN & SAVE" FIX ---
    async function savePdf() {
        if(!originalBytes) return alert("Please open a PDF first.");
        
        // Step 1: Hide all UI borders
        document.body.classList.add('export-mode');

        try {
            // Step 2: Load with encryption bypass and metadata stripping
            const pdfDoc = await PDFDocument.load(originalBytes, { ignoreEncryption: true });
            const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            const page = pdfDoc.getPages()[0];
            const { width, height } = page.getSize();
            const canvas = document.getElementById('pdf-canvas');
            
            const sx = width / canvas.width;
            const sy = height / canvas.height;

            for (let el of overlays) {
                const rect = el.getBoundingClientRect();
                const canvRect = canvas.getBoundingClientRect();
                
                // Math for absolute positioning inside the PDF grid
                const drawX = (rect.left - canvRect.left) * sx;
                const drawY = height - ((rect.top - canvRect.top) * sy) - (el.dataset.type === 'mask' ? (rect.height * sy) : (11 * sy));

                if(el.dataset.type === 'mask') {
                    // This creates the white solid block. NO BORDER is drawn here.
                    page.drawRectangle({
                        x: drawX,
                        y: drawY,
                        width: rect.width * sx,
                        height: rect.height * sy,
                        color: rgb(1, 1, 1), // Pure White
                        borderWidth: 0      // Ensures NO LINE is drawn
                    });
                } else {
                    // This draws the new text
                    page.drawText(el.innerText, {
                        x: drawX,
                        y: drawY,
                        size: 11 * sy,
                        font: font,
                        color: rgb(0, 0, 0)
                    });
                }
            }

            // Step 3: Use a data stream save to prevent "Too Large" errors
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "OIH_Clean_Edit.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
        } catch (err) {
            console.error("Critical Save Error:", err);
            alert("This PDF is too secure. TIP: Open it in Chrome, click Print -> Save as PDF, then upload THAT new version.");
        } finally {
            document.body.classList.remove('export-mode');
        }
    }
</script>
</body>
</html>

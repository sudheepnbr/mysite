<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OIH PDF Master - OCR Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --gold: #c9a035; --dark: #0a0a0a; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #151515; color: white; overflow: hidden; }
        
        /* Dashboard */
        .toolbar { background: #000; padding: 10px; border-bottom: 2px solid var(--gold); display: flex; justify-content: center; gap: 8px; z-index: 1000; position: relative; }
        .btn { padding: 8px 14px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-ocr { background: #6366f1; color: white; } /* Indigo for OCR */
        .btn-tool { background: var(--gold); color: #000; }
        .btn-save { background: #10b981; color: white; }
        
        #loading-overlay { display: none; position: fixed; top: 60px; left: 0; right: 0; background: var(--gold); color: black; padding: 5px; text-align: center; font-size: 12px; z-index: 2000; font-weight: bold; }

        /* Workspace */
        #workspace { height: calc(100vh - 70px); overflow: auto; padding: 40px; display: flex; justify-content: center; }
        #canvas-wrap { position: relative; background: white; box-shadow: 0 0 50px rgba(0,0,0,1); }
        canvas { display: block; }

        /* Editable OCR Layers */
        .ocr-box { 
            position: absolute; color: transparent; background: rgba(99, 102, 241, 0.1); 
            cursor: text; border: 1px solid transparent; transition: 0.1s;
        }
        .ocr-box:hover { background: rgba(99, 102, 241, 0.3); border-color: var(--gold); }
        .ocr-box:focus { color: black; background: white; border-color: var(--gold); outline: none; z-index: 100; }

        /* Custom Overlays */
        .overlay { position: absolute; cursor: move; }
        .mask { background: white; border: 1px dashed #ccc; }
        .resizer { width: 8px; height: 8px; background: var(--gold); position: absolute; right: -4px; bottom: -4px; cursor: se-resize; border-radius: 50%; }
        
        .exporting .ocr-box { background: transparent !important; border: none !important; color: black !important; }
        .exporting .mask { border: none !important; }
        .exporting .resizer { display: none !important; }
    </style>
</head>
<body>

<div id="loading-overlay">OCR is scanning document... Please wait...</div>

<div class="toolbar">
    <input type="file" id="pdf-input" accept="application/pdf" style="display:none">
    <button class="btn btn-tool" onclick="document.getElementById('pdf-input').click()">üìÇ Open PDF</button>
    <button class="btn btn-ocr" onclick="runOCR()">üîç Run OCR (Make Editable)</button>
    <button class="btn btn-tool" onclick="addMask()">‚¨ú Erase Area</button>
    <button class="btn btn-tool" onclick="addText()">‚ûï Custom Text</button>
    <button class="btn btn-save" onclick="savePdf()">üíæ Save Document</button>
</div>

<div id="workspace">
    <div id="canvas-wrap">
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>

<script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    let pdfBytes = null;
    let overlays = [];

    // --- 1. LOAD PDF ---
    document.getElementById('pdf-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        pdfBytes = await file.arrayBuffer();
        renderPage();
    };

    async function renderPage() {
        const pdf = await pdfjsLib.getDocument({data: pdfBytes}).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 1.5});
        const canvas = document.getElementById('pdf-canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height; canvas.width = viewport.width;
        await page.render({canvasContext: context, viewport: viewport}).promise;
        document.getElementById('canvas-wrap').style.width = canvas.width+'px';
    }

    // --- 2. OCR ENGINE (THE MAGIC) ---
    async function runOCR() {
        if(!pdfBytes) return alert("Upload a PDF first");
        const loader = document.getElementById('loading-overlay');
        loader.style.display = 'block';

        const canvas = document.getElementById('pdf-canvas');
        
        // Tesseract scans the canvas directly
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        const { data } = await worker.recognize(canvas);
        
        // Create editable boxes for every detected word
        data.words.forEach(word => {
            const span = document.createElement('div');
            span.className = 'ocr-box';
            span.contentEditable = true;
            span.innerText = word.text;
            
            // Position exactly over original text
            span.style.left = word.bbox.x0 + 'px';
            span.style.top = word.bbox.y0 + 'px';
            span.style.width = (word.bbox.x1 - word.bbox.x0) + 'px';
            span.style.height = (word.bbox.y1 - word.bbox.y0) + 'px';
            span.style.fontSize = (word.bbox.y1 - word.bbox.y0) * 0.8 + 'px';

            document.getElementById('canvas-wrap').appendChild(span);
            overlays.push(span);
        });

        await worker.terminate();
        loader.style.display = 'none';
        alert("OCR Complete! You can now click on any text in the document to edit it.");
    }

    // --- 3. MANUAL TOOLS ---
    function addMask() {
        const div = createUI('mask');
        div.style.width = "100px"; div.style.height = "25px";
    }

    function addText() {
        const div = createUI('text-box');
        div.className += ' ocr-box'; // Use same styling
        div.style.color = 'black';
        div.innerText = "New Text";
    }

    function createUI(type) {
        const div = document.createElement('div');
        div.className = `overlay ${type}`;
        div.dataset.type = type;
        div.style.left = "50px"; div.style.top = "50px";
        
        if(type === 'text-box') {
            div.contentEditable = true;
        } else {
            const rs = document.createElement('div');
            rs.className = 'resizer';
            div.appendChild(rs);
            setupResize(div, rs);
        }

        document.getElementById('canvas-wrap').appendChild(div);
        setupDrag(div);
        overlays.push(div);
        return div;
    }

    // --- 4. INTERACTION ---
    function setupDrag(el) {
        el.onmousedown = (e) => {
            if(e.target.className === 'resizer') return;
            let ox = e.clientX - el.offsetLeft, oy = e.clientY - el.offsetTop;
            document.onmousemove = (e) => { el.style.left = (e.clientX-ox)+'px'; el.style.top = (e.clientY-oy)+'px'; };
            document.onmouseup = () => document.onmousemove = null;
        };
    }

    function setupResize(el, rs) {
        rs.onmousedown = (e) => {
            e.stopPropagation();
            document.onmousemove = (e) => {
                el.style.width = (e.clientX - el.getBoundingClientRect().left)+'px';
                el.style.height = (e.clientY - el.getBoundingClientRect().top)+'px';
            };
            document.onmouseup = () => document.onmousemove = null;
        };
    }

    // --- 5. SAVE ---
    async function savePdf() {
        if(!pdfBytes) return;
        document.body.classList.add('exporting');
        try {
            const doc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });
            const font = await doc.embedFont(StandardFonts.Helvetica);
            const page = doc.getPages()[0];
            const { width, height } = page.getSize();
            const canv = document.getElementById('pdf-canvas');
            const sx = width / canv.width, sy = height / canv.height;

            for (let el of overlays) {
                const r = el.getBoundingClientRect();
                const cr = canv.getBoundingClientRect();
                const px = (r.left - cr.left) * sx;
                const py = height - ((r.top - cr.top) * sy) - (r.height * sy);

                if(el.classList.contains('mask')) {
                    page.drawRectangle({ x: px, y: py, width: r.width*sx, height: r.height*sy, color: rgb(1,1,1) });
                } else {
                    // Draw White background under edited OCR text to hide original
                    page.drawRectangle({ x: px, y: py, width: r.width*sx, height: r.height*sy, color: rgb(1,1,1) });
                    page.drawText(el.innerText, { x: px, y: py + 2, size: (r.height * sy) * 0.8, font: font, color: rgb(0,0,0) });
                }
            }

            const out = await doc.save();
            const blob = new Blob([out], {type: 'application/pdf'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob); link.download = "OIH_OCR_Edited.pdf"; link.click();
        } catch(e) { console.error(e); alert("Save Error"); }
        finally { document.body.classList.remove('exporting'); }
    }
</script>
</body>
</html>

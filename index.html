<!DOCTYPE html>
<html>
<head>
    <title>OIH Cloud PDF Editor</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        #pdf-container { position: relative; border: 2px solid #c9a035; display: inline-block; background: #333; }
        .text-overlay { 
            position: absolute; border: 1px dashed var(--gold); 
            color: black; cursor: move; padding: 2px;
        }
        .toolbar { background: #1a1a1a; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        canvas { display: block; }
    </style>
</head>
<body style="background: #000; color: #fff; font-family: sans-serif;">

    <div class="toolbar">
        <input type="file" id="upload-pdf" accept="application/pdf">
        <button onclick="addTextField()">âž• Add Text</button>
        <button onclick="exportModifiedPDF()" style="background: #10b981; color: white;">ðŸ’¾ Save Edited PDF</button>
    </div>

    <div id="pdf-container">
        <canvas id="pdf-render"></canvas>
    </div>

<script>
    const { PDFDocument, rgb } = PDFLib;
    let existingPdfBytes = null;
    let textElements = [];

    // --- 1. LOAD & RENDER PDF ---
    document.getElementById('upload-pdf').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        existingPdfBytes = await file.arrayBuffer();
        
        const loadingTask = pdfjsLib.getDocument({data: existingPdfBytes});
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1); // Load first page
        
        const viewport = page.getViewport({scale: 1.5});
        const canvas = document.getElementById('pdf-render');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({canvasContext: context, viewport: viewport}).promise;
    });

    // --- 2. ADD EDITABLE TEXT ---
    function addTextField() {
        const div = document.createElement('div');
        div.className = 'text-overlay';
        div.contentEditable = true;
        div.innerText = "Type here...";
        div.style.left = "50px";
        div.style.top = "50px";
        
        // Simple drag logic
        div.onmousedown = (e) => {
            let shiftX = e.clientX - div.getBoundingClientRect().left;
            let shiftY = e.clientY - div.getBoundingClientRect().top;
            document.onmousemove = (e) => {
                div.style.left = e.clientX - shiftX + 'px';
                div.style.top = e.clientY - shiftY + 'px';
            };
            document.onmouseup = () => { document.onmousemove = null; };
        };
        
        document.getElementById('pdf-container').appendChild(div);
        textElements.push(div);
    }

    // --- 3. EXPORT EDITED PDF ---
    async function exportModifiedPDF() {
        if (!existingPdfBytes) return alert("Upload a PDF first");

        const pdfDoc = await PDFDocument.load(existingPdfBytes);
        const pages = pdfDoc.getPages();
        const firstPage = pages[0];
        const { height } = firstPage.getSize();

        for (let el of textElements) {
            const rect = el.getBoundingClientRect();
            const containerRect = document.getElementById('pdf-render').getBoundingClientRect();
            
            // Map HTML coordinates to PDF coordinates
            const x = (rect.left - containerRect.left) * (firstPage.getWidth() / containerRect.width);
            const y = height - ((rect.top - containerRect.top) * (firstPage.getHeight() / containerRect.height)) - 12;

            firstPage.drawText(el.innerText, {
                x: x,
                y: y,
                size: 12,
                color: rgb(0, 0, 0),
            });
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Edited_Document.pdf";
        link.click();
    }
</script>
</body>
</html>
